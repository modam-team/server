name: CICD

on:
  push:
    branches: ["**"]
  pull_request:
    types: [closed]
    branches: [main]

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-only:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      JWT_KEY: ${{ secrets.ALADIN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Gradle Build and Unit Test
        run: ./gradlew clean build --no-daemon

  docker-publish:
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'
      || (github.event_name == 'push' &&
                (github.ref == 'refs/heads/main'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch builds)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx (use docker-container driver so cache export works)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tag (short SHA)
        id: vars
        run: echo "sha_tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image (buildx, multi-stage)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            hwangrock/modam:latest
            hwangrock/modam:${{ steps.vars.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Logout from Docker Hub
        if: always()
        run: docker logout


  deploy-ec2:
    if: github.event_name == 'push' && github.ref == 'refs/heads/deploy'
    runs-on: ubuntu-latest
    needs: [ ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to EC2 via SSH (pull image & restart)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          timeout: 120s
          script: |
            set -euo pipefail

            # 환경 변수 설정 (GitHub Secrets에서 가져옴)
            ALADIN_SECRET="${{ secrets.ALADIN }}"
            DB_URL="${{ secrets.DB_URL }}"
            DB_USERNAME="${{ secrets.DB_USERNAME }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
            KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
            KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}"
            JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}"
            
            
            # 1) Docker Hub 로그인
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # 2) 최신 이미지 pull
            docker pull hwangrock/modam:latest

            # 3) 실행 중인 기존 컨테이너 정리
            EXISTING="$(docker ps -a -q -f name=modam_server || true)"
            if [ -n "$EXISTING" ]; then
              docker stop modam_server || true
              docker rm modam_server || true
            fi

            # 4) 새 컨테이너 실행 (DB 변수 주입)
            docker run -d \
              --name modam_server \
              -p 8080:8080 \
              -e ALADIN="$ALADIN_SECRET" \
              -e SPRING_DATASOURCE_URL="$DB_URL" \
              -e SPRING_DATASOURCE_USERNAME="$DB_USERNAME" \
              -e SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
              -e KAKAO_CLIENT_ID="$KAKAO_CLIENT_ID" \
              -e KAKAO_CLIENT_SECRET="$KAKAO_CLIENT_SECRET" \
              -e KAKAO_REDIRECT_URI="$KAKAO_REDIRECT_URI" \
              -e JWT_SECRET_KEY="$JWT_SECRET_KEY" \
              --restart unless-stopped \
              hwangrock/modam:latest

            # 5) 로그아웃
            docker logout
