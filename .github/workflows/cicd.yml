name: CICD

on:
  push:
    branches: ["**"]
  pull_request:
    types: [closed]
    branches: [main]

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-only:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      JWT_KEY: ${{ secrets.ALADIN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Gradle Build (no tests)
        run: ./gradlew clean build --no-daemon -x test

  docker-publish:
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'
      || (github.event_name == 'push' &&
                (github.ref == 'refs/heads/main' || github.ref=='refs/heads/deploy')) 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Gradle Build (no tests)
        run: ./gradlew clean build --no-daemon -x test

      - name: Set image tag (short SHA)
        id: vars
        run: |
          SHA_TAG=${GITHUB_SHA::7}
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build -t hwangrock/modam:latest \
                       -t hwangrock/modam:${{ steps.vars.outputs.sha_tag }} .

      - name: Push Docker image
        run: |
          docker push hwangrock/modam:latest
          docker push hwangrock/modam:${{ steps.vars.outputs.sha_tag }}

      - name: Logout
        if: always()
        run: docker logout

      # EC2 배포 단계
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # 환경 변수로 secret 설정
            ALADIN_SECRET="${{ secrets.ALADIN }}"

            # 디버깅: secret이 제대로 전달되었는지 확인 (길이 출력)
            echo "ALADIN secret length: ${#ALADIN_SECRET}"
            # 디버깅 끝
            
            # 1. EC2에서 Docker Hub 로그인
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            # 2. 실행 중인 이전 컨테이너 종료 및 삭제
            if [ $(docker ps -a -q -f name=modam_server) ]; then
              docker stop modam_server
              docker rm modam_server
            fi

            # 3. 최신 이미지 다운로드
            docker pull hwangrock/modam:latest

            # 4. 새로운 컨테이너 실행
            docker run -d --name modam_server -p 8080:8080 -e ALADIN="$ALADIN_SECRET" hwangrock/modam:latest

            # 5. docker hub 로그아웃
            docker logout
